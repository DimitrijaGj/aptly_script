# Download public repo key
wget -O /etc/apt/keyrings/aptly.asc https://www.aptly.info/pubkey.txt

# Add repository
echo "deb [signed-by=/etc/apt/keyrings/aptly.asc] http://repo.aptly.info/ squeeze main" | sudo tee /etc/apt/sources.list.d/aptly.list

# Install aptly and nginx
apt-get update && apt-get install aptly nginx

# Add nginx vhost
nano /etc/nginx/sites-available/linux-mirrors.stg.sys.mgh.reuter365.net
    server {
    listen 80;
    server_name linux-mirrors.stg.sys.mgh.reuter365.net;

    access_log /var/log/nginx/packages-error.log;
    error_log /var/log/nginx/packages-error.log;

    location / {
        root /mnt/mirrors/public;
        index index.html;
        autoindex on;
    }
    }

# Activate nginx vhost
ln -s /etc/nginx/sites-available/linux-mirrors.stg.sys.mgh.reuter365.net /etc/nginx/sites-enabled

# Remove default nginx site
rm /etc/nginx/sites-enabled/default

# Restart nginx
systemctl restart nginx

# Add aptly config
nano .aptly.conf #0644
{
     "rootDir": "/mnt/mirrors",
    "downloadConcurrency": 4,
    "downloadSpeedLimit": 0,
    "downloadRetries": 0,
    "downloader": "default",
    "databaseOpenAttempts": -1,
    "architectures": [],
    "dependencyFollowSuggests": false,
    "dependencyFollowRecommends": false,
    "dependencyFollowAllVariants": false,
    "dependencyFollowSource": false,
    "dependencyVerboseResolve": false,
    "gpgDisableSign": false,
    "gpgDisableVerify": false,
    "gpgProvider": "gpg",
    "downloadSourcePackages": false,
    "skipLegacyPool": true,
    "ppaDistributorID": "ubuntu",
    "ppaCodename": "",
    "skipContentsPublishing": false,
    "skipBz2Publishing": false,
    "FileSystemPublishEndpoints": {},
    "S3PublishEndpoints": {},
    "SwiftPublishEndpoints": {},
    "AzurePublishEndpoints": {},
    "AsyncAPI": false,
    "enableMetricsEndpoint": false
}

# Do something with gpg keys
gpg --no-default-keyring --keyring /usr/share/keyrings/debian-archive-keyring.gpg --export | gpg --no-default-keyring --keyring trustedkeys.gpg --import
